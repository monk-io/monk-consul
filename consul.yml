namespace: monk-consul

consul-common:
  metadata:
    defines: metadata
    name: Consul by HashiCorp
    description: Consul is a service networking solution to automate network configurations, discover services, and enable secure connectivity across any cloud or runtime.
    website: https://www.consul.io
    publisher: monk.io
    icon: logo.png
  connections:
    consul-node1:
      runnable: monk-consul/consul-node1
      service: consul-svc
    consul-node2:
      runnable: monk-consul/consul-node2
      service: consul-svc
  variables:
    node1_host:
      env: node1
      type: string
      value: <- connection-hostname("consul-node1") split(".dns.podman") join("")
    node2_host:
      env: node2
      type: string
      value: <- connection-hostname("consul-node2") split(".dns.podman") join("")
    client_host:
      type: string
      value: <- connection-hostname("consul-client") split(".dns.podman") join("")
    

consul-node1:
  defines: runnable
  inherits: monk-consul/consul-common
  variables:
    node:
      env: node
      type: string
      value: <- `${node1_host}`
    node1:
      env: node1
      type: string
      value: <- `${node1_host}`
    node2:
      env: node2
      type: string
      value: <- `${node2_host}`
  containers:
    consul:
      image: consul
      ports:
        - 0.0.0.0:8500:8500
        - 0.0.0.0:8600:8600/tcp
        - 0.0.0.0:8300:8300/tcp
        - 0.0.0.0:8301:8301/tcp
        - 0.0.0.0:8302:8302/tcp
        - 0.0.0.0:8600:8600/udp
        - 0.0.0.0:8301:8301/udp
        - 0.0.0.0:8302:8302/udp
      paths:
        - <- `${moncc-volume-path}/consul-node1:/consul/data`
      bash: /opt/init.sh
  files:
    server-def:
      container: consul
      path: /opt/init.sh
      mode: 755
      contents: |
        #!/bin/sh
        
        host=$(ping -c 1 ${node} | grep '64 bytes from ' | awk '{print $5}' | tr -d '():')
        consul agent -server -bootstrap-expect 2 -retry-join ${node2} -advertise ${host} -data-dir=/consul/data -ui -client 0.0.0.0
  services:
    consul-svc:
      container: consul
      port: 8500
      protocol: tcp
      
consul-node2:
  defines: runnable
  inherits: monk-consul/consul-common
  variables:
    node:
      env: node
      type: string
      value: <- `${node2_host}`
    node1:
      env: node1
      type: string
      value: <- `${node1_host}`
    node2:
      env: node2
      type: string
      value: <- `${node2_host}`
  containers:
    consul:
      image: consul
      ports:
        - 0.0.0.0:8501:8500
      paths:
        - <- `${moncc-volume-path}/consul-node2:/consul/data`
      bash: /opt/init.sh
  depends:
    wait-for:
      runnables:
        - monk-consul/consul-node1
  files:
    server-def:
      container: consul
      path: /opt/init.sh
      mode: 755
      contents: |
        #!/bin/sh

        host=$(ping -c 1 ${node} | grep '64 bytes from ' | awk '{print $5}' | tr -d '():')
        consul agent -server -bootstrap-expect 2 -retry-join ${node1} -advertise ${host} -data-dir=/consul/data -ui -client 0.0.0.0
  services:
    consul-svc:
      container: consul
      port: 8500
      protocol: tcp

consul-client:
  defines: runnable
  inherits: monk-consul/consul-common
  variables:
    node:
      env: node
      type: string
      value: <- `${client_host}`
    node1:
      env: node1
      type: string
      value: <- `${node1_host}`
    node2:
      env: node2
      type: string
      value: <- `${node2_host}`
  containers:
    client:
      image: consul
      paths:
        - <- `${moncc-volume-path}/consul-client:/consul/data`
      bash: /opt/init.sh
  files:
    server-def:
      container: client
      path: /opt/init.sh
      mode: 755
      contents: |
        #!/bin/sh

        host=$(ping -c 1 ${node} | grep '64 bytes from ' | awk '{print $5}' | tr -d '():')
        consul agent -retry-join ${node1} -retry-join ${node2} -data-dir=/consul/data  -advertise ${host}
